<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recomendaciones - Asistente Acad√©mico</title>
    <link rel="stylesheet" href="css/recomendaciones.css">
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="assets/images/uia_icon.png" alt="UIA Logo">
        </div>
        <div class="menu-items">
            <div class="menu-item" onclick="navigate('dashboard')">
                <span>üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" onclick="navigate('historial')">
                <span>üìö</span>
                <span>Mi Historial</span>
            </div>
            <div class="menu-item active">
                <span>üí°</span>
                <span>Recomendaciones</span>
            </div>
            <div class="menu-item" onclick="navigate('cursos')">
                <span>üìñ</span>
                <span>Cat√°logo de Cursos</span>
            </div>
        </div>
        <div class="logout-section">
            <button class="logout-btn" onclick="logout()">
                <span>üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <a href="dashboard.html" class="back-btn">‚Üê Volver al Dashboard</a>
        </div>


        <div class="content-section" id="formSection">
            <h2 class="section-title">Obtener Recomendaciones Personalizadas</h2>
            
            <form id="recommendationForm">
                <div class="form-group">
                    <label>Selecciona los cursos que ya has aprobado:</label>
                    <div class="checkbox-grid" id="cursosGrid">

                    </div>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">
                    ü§ñ Generar Recomendaciones con IA
                </button>
            </form>
        </div>


        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>Analizando tu historial acad√©mico...</h3>
            <p>El motor Prolog est√° evaluando requisitos y la IA est√° preparando tus recomendaciones</p>
        </div>


        <div class="results-container" id="resultsContainer">
            <div class="content-section">
                <h2 class="section-title">‚ú® Tus Recomendaciones Personalizadas</h2>
                <div id="recommendationsList"></div>
            </div>

            <button class="btn-primary" onclick="nuevaConsulta()">Nueva Consulta</button>
        </div>
    </div>

    <script>

        const cursosDisponibles = [
            { codigo: 'SOF-01', nombre: 'Introducci√≥n a la Programaci√≥n', creditos: 3, nivel: 'inicial' },
            { codigo: 'SOF-02', nombre: 'Estructuras de Datos', creditos: 3, nivel: 'intermedio', requisitos: ['SOF-01'] },
            { codigo: 'SOF-03', nombre: 'Algoritmos', creditos: 3, nivel: 'intermedio', requisitos: ['SOF-02'] },
            { codigo: 'SOF-04', nombre: 'Bases de Datos I', creditos: 3, nivel: 'intermedio', requisitos: ['SOF-01'] },
            { codigo: 'SOF-05', nombre: 'Bases de Datos II', creditos: 3, nivel: 'avanzado', requisitos: ['SOF-04'] },
            { codigo: 'SOF-06', nombre: 'Desarrollo Web', creditos: 3, nivel: 'intermedio', requisitos: ['SOF-01'] },
            { codigo: 'SOF-07', nombre: 'Programaci√≥n Orientada a Objetos', creditos: 3, nivel: 'intermedio', requisitos: ['SOF-02'] },
            { codigo: 'SOF-08', nombre: 'Ingenier√≠a de Software', creditos: 4, nivel: 'avanzado', requisitos: ['SOF-07'] },
        ];

        window.onload = function() {

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            cargarCursos();
        };

        function cargarCursos() {
            const grid = document.getElementById('cursosGrid');
            cursosDisponibles.forEach(curso => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" id="${curso.codigo}" value="${curso.codigo}">
                    <label for="${curso.codigo}">
                        <span class="course-code">${curso.codigo}</span> - ${curso.nombre}
                    </label>
                `;
                grid.appendChild(item);
            });
        }

        document.getElementById('recommendationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const checkboxes = document.querySelectorAll('#cursosGrid input[type="checkbox"]:checked');
            const cursosAprobados = Array.from(checkboxes).map(cb => cb.value);

            if (cursosAprobados.length === 0) {
                alert('Por favor selecciona al menos un curso aprobado');
                return;
            }

 
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {

                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/api/recomendaciones', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ cursosAprobados })
                });

                if (response.ok) {
                    const recomendaciones = await response.json();
                    mostrarRecomendaciones(recomendaciones);
                } else {
                    throw new Error('Error al obtener recomendaciones');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al obtener recomendaciones. Por favor intenta de nuevo.');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('formSection').style.display = 'block';
            }
        });

        function mostrarRecomendaciones(recomendaciones) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';

            const lista = document.getElementById('recommendationsList');
            lista.innerHTML = '';

            if (recomendaciones.length === 0) {
                lista.innerHTML = '<div class="no-recommendations"><h3>No hay cursos disponibles</h3><p>Has completado todos los requisitos o no hay cursos disponibles en este momento.</p></div>';
                return;
            }

            recomendaciones.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.innerHTML = `
                    <div class="course-header">
                        <div class="course-info">
                            <h3>${rec.codigo} - ${rec.nombre}</h3>
                            <p class="course-meta">üìö ${rec.creditos} cr√©ditos | üìä Nivel: ${rec.nivel}</p>
                        </div>
                        <div class="course-badge">Recomendado</div>
                    </div>

                    <div class="prolog-analysis">
                        <h4>üîç An√°lisis L√≥gico (Prolog)</h4>
                        <ul>
                            ${rec.analisisProlog.map(punto => `<li>${punto}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="ai-explanation">
                        <h4>ü§ñ Explicaci√≥n IA</h4>
                        <p>${rec.explicacionIA}</p>
                    </div>
                `;
                lista.appendChild(card);
            });
        }

        function nuevaConsulta() {
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('formSection').style.display = 'block';
            document.querySelectorAll('#cursosGrid input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function navigate(page) {
            window.location.href = `${page}.html`;
        }

        function logout() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                alert('Sesi√≥n cerrada correctamente');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>